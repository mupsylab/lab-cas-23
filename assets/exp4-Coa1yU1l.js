import{J as p,_ as A,u as N,a as R,f as z,S as J,p as K,I as T,h as C,H as $,E as U,c as W}from"./index-Coc0i56b.js";import{d as F,g as G,j as B,$ as O,a as q,o as I,b as c,h as o,a0 as Q}from"./vendor-C0OfONeZ.js";import{E as j}from"./EnterFullScreen-CMkwcFAG.js";const D=F({__name:"Stimlu",props:{imgs:{type:Array,required:!0},seq:{type:Array,required:!0},detection_index:{type:Number,required:!0}},setup(g){let t={start_time:-1,end_time:-1,resp_time:-1,resp_frame:-1,resp_index:-1};const s={loop:20,rest:2};function M(){return t.resp_index!=-1&&t.resp_index<e.detection_index?"#ff0000":t.resp_index>=e.detection_index?"#00ff00":"#d3d3d3"}function f(){return Promise.all(e.imgs.map(n=>new Promise(u=>{const d=document.createElement("img");d.onload=()=>{u(d)},d.src=n})))}const e=g,a=[];let i=!0,r=0,m=Math.random()*.3+.85;function x(){const n=l.value.getContext("2d");if(!n)return;n.clearRect(0,0,l.value.width,l.value.height),n.save(),n.beginPath();const u=Math.floor(r/s.loop);if(r%s.loop>=s.loop-s.rest){m=Math.random()*.3+.85,r+=1,i&&window.requestAnimationFrame(x);return}if(u>=e.seq.length){t.end_time=p.instance.currTime,H();return}const d=e.seq[u],v=a[Math.abs(d)],y=Math.floor(v.width*.1*m),w=Math.floor(v.height*.1*m),E=Math.floor((l.value.width-y)/2),S=Math.floor((l.value.height-w)/2),k=Math.floor(30*m);if(n.fillStyle=M(),n.rect(E,S-k,y,k*2+w),n.fill(),n.drawImage(v,0,0,v.width,v.height,E,S,y,w),d<0){const h=n.getImageData(E,S,y,w),b=[];h.data.forEach((ce,_)=>{if(_%4==0){const L=Math.round((h.data[_]+h.data[_+1]+h.data[_+2])/3);b[_]=b[_+1]=b[_+2]=L,b[_+3]=255}});const P=n.createImageData(h.width,h.height);P.data.set(b),n.putImageData(P,(l.value.width-y)/2,(l.value.height-w)/2)}n.restore(),r+=1,i&&window.requestAnimationFrame(x)}const l=G();B(()=>{l.value.width=window.innerWidth,l.value.height=window.innerHeight,l.value.getContext("2d")&&f().then(u=>{u.forEach(d=>{a.push(d)}),x(),t.start_time=p.instance.currTime,p.plugin.keyboard.addListener(V)})}),O(()=>{i=!1});function H(){p.instance.currTrial.finish({trial_type:"RSVP",...t})}function V(n,u){n.key==" "&&(t.resp_frame=r,p.plugin.keyboard.removeListener(V),t.resp_time=u,t.resp_index=Math.floor(t.resp_frame/s.loop))}return(n,u)=>(I(),q("canvas",{ref_key:"dom",ref:l},null,512))}}),X={};function Y(g,t){return I(),q("div",null,[...t[0]||(t[0]=[c("p",null,"接下来，您将进入“FPSV”游戏。",-1),c("p",null,"在本环节中，会呈现一系列的面孔，当你看到灰色面孔的时候，请及时按下空格键。",-1),c("p",null,"请注意：",-1),c("p",null,"如果不确定，也可以凭直觉选择。",-1),c("p",null,"请保持专注并尽量快速作答",-1),c("p",null,"如已明白操作方式，请点击“开始练习”按钮，先进行练习环节。",-1)])])}const Z=A(X,[["render",Y]]),ee={};function te(g,t){return I(),q("div",null,[...t[0]||(t[0]=[c("p",null,"现在进入练习环节。",-1),c("p",null,"每完成一道练习题，系统会提示您的选择是否正确。只有全部练习题答对后，才能进入正式测试。如果有答错，系统会让您重新尝试，直到全部答对为止。",-1),c("p",null,"练习阶段不计入正式成绩，仅用于帮助您熟悉操作方式。如有疑问，请随时提问。",-1),c("p",null,"如已明白，请点击【开始练习】。",-1)])])}const ne=A(ee,[["render",te]]),re={};function se(g,t){return I(),q("div",null,[...t[0]||(t[0]=[c("p",null,"练习环节已全部通过！",-1),c("p",null,"接下来将进入正式测试。正式测试不再提供即时反馈请根据下方人物的表情，将其拖动到您认为最为相似的上方人物下方。本阶段不再显示正确或错误提示。请您尽量保持专注，独立完成所有题目。",-1),c("p",null,"请点击【开始】进入下一步。",-1)])])}const oe=A(re,[["render",se]]),ie={id:"exp"},ae=F({__name:"exp4",setup(g){p.opts={...p.opts,iti:0,toastClose:!0};const t=p.instance,s=[],M=N();s.push({component:o(R,{assets:[...z]})});const f=["exp4"];return s.push({component:o(J,{ques:K}),on_finish(e){f.push(`${p.instance.currTime}`),f.push(e.name),f.push(e.gender),f.push(e.idcard)}}),s.push({component:o(j,{model:!0})}),s.push({component:o(T,{pages:[Z]})}),s.push({timeline:[{component:o(T,{pages:[ne]})},{timeline:[{component(){return o($,{stimulus:"+",stimulus_duration:500,trial_duration_time:1e3})}},{component(){const{imgs:e,seq:a,detection:i}=t.currTrial.parent.getAllTimelineVariables();return o(D,{imgs:e.map(r=>M.getAssets(r)),seq:a,detection_index:i})},on_finish(e){const{imgs:a,seq:i,detection:r,rsvp_iti:m}=t.currTrial.parent.getAllTimelineVariables(),{resp_index:x}=e;e.cond_imgs=a,e.cond_seq=i,e.cond_detection=r,e.cond_iti=m,e.correct=x>=r?1:0,e.prac=1}},{component(){const{correct:e}=t.data.get().last(1).values()[0];return o($,{stimulus:e==1?"你选对了！":"再想一想",stimulus_duration:500,trial_duration_time:1e3})}}],timeline_variables:C,randomize_order:!0,trial_num:6}],loop_function(){const e=t.data.get().filter({trial_type:"RSVP"}).last(6).select("correct").mean();return!e||e<.8?(Q.error("正确率过低, 重新练习"),!0):!1}}),s.push({component:o(T,{pages:[oe]})}),s.push({timeline:[{component(){return o($,{stimulus:"+",stimulus_duration:500,trial_duration_time:1e3})}},{component(){const{imgs:e,seq:a,detection:i}=t.currTrial.parent.getAllTimelineVariables();return o(D,{imgs:e.map(r=>M.getAssets(r)),seq:a,detection_index:i})},on_finish(e){const{imgs:a,seq:i,detection:r}=t.currTrial.parent.getAllTimelineVariables(),{resp_index:m}=e;e.cond_imgs=a,e.cond_seq=i,e.cond_detection=r,e.correct=m>=r?1:0,e.prac=0}},{timeline:[{component:o(T,{pages:[o("p","休息一下吧")]})}],conditional_function(){const a=t.data.get().last(1).values()[0].trial_id.split("-").map(r=>r.split(".")),i=parseInt(a[1][2])+1;return i%60==0&&i>0}}],timeline_variables:C,randomize_order:!0}),s.push({component:o(j,{model:!1})}),s.push({component(){return o(U,{s3:{...W,bucket:"psydata",endpoint:"https://psy.mupsycho.com/oss",signEndpoint:"http://n1.jimoco.cn:29513",region:"cn",fileName:`lab-cas-23/exp4/${f.join("_")}.csv`}})}}),B(()=>{const e=document.querySelector("#exp");t.load(s,e)}),(e,a)=>(I(),q("div",ie))}}),me=A(ae,[["__scopeId","data-v-45c5d951"]]);export{me as default};
