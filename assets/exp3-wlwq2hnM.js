var A=Object.defineProperty;var S=(p,e,s)=>e in p?A(p,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):p[e]=s;var u=(p,e,s)=>S(p,typeof e!="symbol"?e+"":e,s);import{u as V,J as h,_,a as R,f as O,S as q,p as B,I as v,g as E,H as x,E as C,c as D}from"./index-Coc0i56b.js";import{d as F,g as H,j as P,$ as M,a as f,o as y,b as c,h as a,a0 as J}from"./vendor-C0OfONeZ.js";import{E as k}from"./EnterFullScreen-CMkwcFAG.js";class N{constructor(e,s){u(this,"loader",V());u(this,"bgs",[]);u(this,"bgs_len");u(this,"player");u(this,"can_move",!1);u(this,"dx",0);u(this,"dy",0);this.bgs_len=e.length;const n=e.map(t=>this.loadImg(this.loader.getAssets(t)));Promise.all(n).then(t=>{t.forEach(i=>{const r=new T({size:{width:128,height:128},pos:{x:0,y:0}});r.instance=i,this.bgs.push(r)})}),this.loadImg(this.loader.getAssets(s)).then(t=>{const r=new T({size:{width:t.width/10,height:t.height/10},pos:{x:0,y:0}});r.instance=t,this.player=r})}waitForReady(){return new Promise(e=>{const s=()=>{this.isReady?e():setTimeout(s,0)};s()})}get isFinish(){return!this.can_move}get isReady(){return this.bgs.length==this.bgs_len&&this.player!=null}reset(e,s){if(!this.player)return;const n=Math.min(e,s),t=e>s,{width:i,height:r}=this.player.size;this.player.size={width:(t?.15:.2)*n*(i>r?i/r:1),height:(t?.15:.2)*n*(i>r?1:r/i)};const o=50;this.bgs.forEach((d,l)=>{const{width:m,height:g}=d.rsize;switch(d.size={width:(t?.15:.2)*n*(m>g?m/g:1),height:(t?.15:.2)*n*(m>g?1:g/m)},l){case 0:d.pos={x:0+o,y:0+o};break;case 1:d.pos={x:e-this.bgs[1].size.width-o,y:0+o};break;case 2:d.pos={x:0+o,y:s-this.bgs[2].size.height-o};break;case 3:d.pos={x:e-this.bgs[1].size.width-o,y:s-this.bgs[2].size.height-o};break}}),this.player.pos={x:e/2-this.player.size.width/2,y:s-this.player.size.height-o},this.can_move=!0}draw(e){const{width:s,height:n}=e.canvas;e.clearRect(0,0,s,n),this.bgs.forEach(t=>t.draw(e)),this.player&&this.player.draw(e)}loadImg(e){return new Promise((s,n)=>{const t=new Image;t.onload=()=>s(t),t.onerror=n,t.src=e})}getValidFocusObj(e,s){if(this.player&&this.player.isFocus(e,s))return this.dx=e-this.player.pos.x,this.dy=s-this.player.pos.y,this.player}moveValidObj(e,s){!this.player||!this.can_move||(this.player.pos={x:e-this.dx,y:s-this.dy})}judge(e,s){return new Promise(n=>{this.bgs.forEach((t,i)=>{e>t.pos.x&&e<t.pos.x+t.size.width&&s>t.pos.y&&s<t.pos.y+t.size.height&&(this.can_move=!1,n(i))}),n(-1)})}}class T{constructor(e){u(this,"instance");u(this,"size");u(this,"pos");this.instance=document.createElement("img"),this.size=e.size,this.pos=e.pos}get rsize(){return{width:this.instance.width,height:this.instance.height}}set posX(e){this.pos.x=e}set posY(e){this.pos.y=e}draw(e){e&&e.drawImage(this.instance,0,0,this.rsize.width,this.rsize.height,this.pos.x,this.pos.y,this.size.width,this.size.height)}isFocus(e,s){return e>this.pos.x&&e<this.pos.x+this.size.width&&s>this.pos.y&&s<this.pos.y+this.size.height}}const X=F({__name:"DragPage",props:{mid:{type:String,default:"m1"},bgs:{type:Array,default:["b_happy","b_angry"]}},setup(p){const e=p,s=new N(e.bgs,e.mid),n={trial_type:"drag-core",start_time:h.instance.currTime,end_time:-1,rt:-1,response:"",cursors:[],c_picture:e.mid,c_picture_bgs:e.bgs},t=H();P(async()=>{t.value.width=window.innerWidth,t.value.height=window.innerHeight;const l=t.value.getContext("2d");l&&(await s.waitForReady(),s.reset(t.value.width,t.value.height),n.start_time=h.instance.currTime,r(l))}),M(()=>{i=!1});let i=!0;function r(l){i&&(s.draw(l),requestAnimationFrame(()=>r(l)))}const o=l=>{const{type:m,offsetX:g,offsetY:$}=l,[b,w]=[g,$],z=h.instance.currTime;switch(m){case"pointerdown":if(t.value.dataset.drag==="stop"||s.getValidFocusObj(b,w)==null)return;t.value.dataset.drag="dragging";break;case"pointerup":if(t.value.dataset.drag==="stop")return;t.value.dataset.drag="release";break;case"pointermove":if(t.value.dataset.drag!=="dragging")return;s.moveValidObj(b,w),n.end_time=z,n.cursors.push([b,w,s.dx,s.dy,t.value.width,t.value.height,z]),s.judge(b,w).then(I=>{I!==-1&&(t.value.dataset.drag="stop",d(I))});break}},d=l=>{n.response=e.bgs[l],n.rt=n.end_time-n.start_time,h.plugin.timer.setTimeout(()=>{h.instance.currTrial.finish(n)},1e3)};return(l,m)=>(y(),f("canvas",{ref_key:"dom",ref:t,onPointermove:o,onPointerdown:o,onPointerup:o},null,544))}}),j=_(X,[["__scopeId","data-v-b3b5b791"]]),Y={};function K(p,e){return y(),f("div",null,[...e[0]||(e[0]=[c("p",null,"接下来，您将进入“情绪配对”游戏。",-1),c("p",null,"在本环节中，您需判断屏幕下方人物的情绪，并将其拖动到与之情绪相同的上方人物头像下方。每次屏幕上会同时出现三张人物面孔：一张在屏幕下方（待判断），两张在屏幕上方（作为选项）。您需要仔细观察下方人物的表情，并在上方的两个人物中，选择您认为表情最为相似、情绪相同的一位，将下方人物拖拽至其下方。",-1),c("p",null,"请注意：",-1),c("p",null,"每一题仅有一个正确答案，请尽量根据人物的表情做出判断。",-1),c("p",null,"如果不确定，也可以凭直觉选择。",-1),c("p",null,"请保持专注并尽量快速作答",-1),c("p",null,"如已明白操作方式，请点击“开始练习”按钮，先进行练习环节。",-1)])])}const L=_(Y,[["render",K]]),U={};function W(p,e){return y(),f("div",null,[...e[0]||(e[0]=[c("p",null,"现在进入练习环节。",-1),c("p",null,"每完成一道练习题，系统会提示您的选择是否正确。只有全部练习题答对后，才能进入正式测试。如果有答错，系统会让您重新尝试，直到全部答对为止。",-1),c("p",null,"练习阶段不计入正式成绩，仅用于帮助您熟悉操作方式。如有疑问，请随时提问。",-1),c("p",null,"如已明白，请点击【开始练习】。",-1)])])}const G=_(U,[["render",W]]),Q={};function Z(p,e){return y(),f("div",null,[...e[0]||(e[0]=[c("p",null,"练习环节已全部通过！",-1),c("p",null,"接下来将进入正式测试。正式测试不再提供即时反馈请根据下方人物的表情，将其拖动到您认为最为相似的上方人物下方。本阶段不再显示正确或错误提示。请您尽量保持专注，独立完成所有题目。",-1),c("p",null,"请点击【开始】进入下一步。",-1)])])}const ee=_(Q,[["render",Z]]),te={id:"exp"},se=F({__name:"exp3",setup(p){h.opts={...h.opts,iti:0,toastClose:!0};const e=h.instance,s=[];s.push({component:a(R,{assets:[...O]})});const n=["exp3"];return s.push({component:a(q,{ques:B}),on_finish(t){n.push(`${h.instance.currTime}`),n.push(t.name),n.push(t.gender),n.push(t.idcard)}}),s.push({component:a(k,{model:!0})}),s.push({component:a(v,{pages:[L]})}),s.push({timeline:[{component:a(v,{pages:[G]})},{timeline:[{component(){return a(x,{stimulus:"+",stimulus_duration:500,trial_duration_time:1e3})}},{component(){const{face:t,bgs:i}=e.currTrial.parent.getAllTimelineVariables();return a(j,{mid:t,bgs:i})},on_finish(t){const{c_picture:i,response:r}=t,o=i.split("-")[1]===r.split("-")[1];t.correct=o?1:0,t.prac=1}},{component(){const{correct:t}=e.data.get().last(1).values()[0];return a(x,{stimulus:t==1?"你选对了！":"再想一想",stimulus_duration:500,trial_duration_time:1e3})}}],timeline_variables:E,randomize_order:!0,trial_num:6}],loop_function(){const t=e.data.get().filter({trial_type:"drag-core"}).last(6).select("correct").mean();return!t||t<.8?(J.error("正确率过低, 重新练习"),!0):!1}}),s.push({component:a(v,{pages:[ee]})}),s.push({timeline:[{component(){return a(x,{stimulus:"+",stimulus_duration:500,trial_duration_time:1e3})}},{component(){const{face:t,bgs:i}=e.currTrial.parent.getAllTimelineVariables();return a(j,{mid:t,bgs:i})},on_finish(t){const{c_picture:i,response:r}=t,o=i.split("-")[1]===r.split("-")[1];t.correct=o?1:0,t.prac=0}},{timeline:[{component:a(v,{pages:[a("p","休息一下吧")]})}],conditional_function(){const i=e.data.get().last(1).values()[0].trial_id.split("-").map(o=>o.split(".")),r=parseInt(i[1][2])+1;return r%30==0&&r>0}}],timeline_variables:E,randomize_order:!0}),s.push({component:a(k,{model:!1})}),s.push({component(){return a(C,{s3:{...D,bucket:"psydata",endpoint:"https://psy.mupsycho.com/oss",signEndpoint:"http://n1.jimoco.cn:29513",region:"cn",fileName:`lab-cas-23/exp3/${n.join("_")}.csv`}})}}),P(()=>{const t=document.querySelector("#exp");e.load(s,t)}),(t,i)=>(y(),f("div",te))}}),ce=_(se,[["__scopeId","data-v-55195004"]]);export{ce as default};
